{% extends 'Cripto1/base.html' %}
{% load static %}

{% block title %}Dettaglio Blocchi - Blockchain{% endblock %}

{% block extra_css %}
<style>
    /* OVERRIDE FORZATO del tema base per questa pagina */
    html, body {
        background-color: #0c0c0c !important;
        color: #00ff88 !important;
        overflow-x: hidden !important;
        min-height: 100vh !important;
    }
    
    .container-fluid {
        background-color: transparent !important;
    }
    
    /* Reset completo delle variabili CSS del tema base */
    :root {
        --background-color: #0c0c0c !important;
        --card-background: rgba(0, 0, 0, 0.8) !important;
        --text-primary: #00ff88 !important;
        --text-secondary: rgba(255, 255, 255, 0.7) !important;
    }
    
    /* Sfondo stellare futuristico */
    .stars-container {
        position: fixed !important;
        width: 100% !important;
        height: 100% !important;
        top: 0 !important;
        left: 0 !important;
        perspective: 500px !important;
        transform-style: preserve-3d !important;
        z-index: -1 !important;
    }
    
    .star-layer {
        position: absolute !important;
        width: 100% !important;
        height: 100% !important;
        top: 0 !important;
        left: 0 !important;
        opacity: 0.8 !important;
    }
    
    .star-layer:nth-child(1) {
        transform: translateZ(-50px) !important;
        animation: star-drift 150s linear infinite !important;
    }
    
    .star-layer:nth-child(2) {
        transform: translateZ(-100px) !important;
        animation: star-drift 200s linear infinite reverse !important;
        opacity: 0.6 !important;
    }
    
    .star-layer:nth-child(3) {
        transform: translateZ(-200px) !important;
        animation: star-drift 250s linear infinite !important;
        opacity: 0.4 !important;
    }
    
    @keyframes star-drift {
        0% { transform: translateZ(-50px) translateY(0); }
        100% { transform: translateZ(-50px) translateY(100%); }
    }
    
    .star-layer::before {
        content: "" !important;
        position: absolute !important;
        width: 100% !important;
        height: 100% !important;
        background-image: radial-gradient(1px 1px at 10% 10%, white 100%, transparent),
            radial-gradient(1px 1px at 20% 20%, white 100%, transparent),
            radial-gradient(2px 2px at 30% 30%, white 100%, transparent),
            radial-gradient(1px 1px at 40% 40%, white 100%, transparent),
            radial-gradient(2px 2px at 50% 50%, white 100%, transparent),
            radial-gradient(1px 1px at 60% 60%, white 100%, transparent),
            radial-gradient(2px 2px at 70% 70%, white 100%, transparent),
            radial-gradient(1px 1px at 80% 80%, white 100%, transparent),
            radial-gradient(2px 2px at 90% 90%, white 100%, transparent),
            radial-gradient(1px 1px at 15% 85%, white 100%, transparent) !important;
    }
    
    /* Nebulosa colorata */
    .nebula {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: radial-gradient(ellipse at 20% 30%, rgba(0, 162, 255, 0.15) 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 70%, rgba(255, 0, 162, 0.1) 0%, transparent 50%),
                    radial-gradient(ellipse at 50% 50%, rgba(0, 255, 136, 0.08) 0%, transparent 50%) !important;
        animation: nebula-drift 60s ease-in-out infinite alternate !important;
        z-index: -1 !important;
    }
    
    @keyframes nebula-drift {
        0% { transform: scale(1) rotate(0deg); }
        100% { transform: scale(1.1) rotate(2deg); }
    }
    
    /* Griglia prospettica */
    .grid-plane {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 50% !important;
        background-image: linear-gradient(rgba(0, 255, 136, 0.1) 1px, transparent 1px),
                          linear-gradient(90deg, rgba(0, 255, 136, 0.1) 1px, transparent 1px) !important;
        background-size: 50px 50px !important;
        transform: perspective(500px) rotateX(60deg) !important;
        transform-origin: bottom !important;
        opacity: 0.3 !important;
        z-index: -1 !important;
        animation: grid-pulse 4s ease-in-out infinite alternate !important;
    }
    
    @keyframes grid-pulse {
        0% { opacity: 0.2; }
        100% { opacity: 0.4; }
    }
    
    /* Container principale blockchain */
    .blockchain-container {
        position: relative !important;
        background: rgba(0, 0, 0, 0.7) !important;
        border-radius: 20px !important;
        border: 2px solid rgba(0, 255, 136, 0.3) !important;
        padding: 30px !important;
        backdrop-filter: blur(15px) !important;
        box-shadow: 0 20px 60px rgba(0, 255, 136, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        margin-bottom: 30px !important;
    }
    
    /* Lista blocchi */
    /* FORZA LA VISUALIZZAZIONE DEI BLOCCHI */
    .blocks-list {
        position: relative !important;
        z-index: 1000 !important;
        background: rgba(0, 0, 0, 0.8) !important;
        padding: 20px !important;
        border-radius: 10px !important;
    }
    
    .block-item {
        position: relative !important;
        z-index: 1001 !important;
        background: rgba(0, 50, 100, 0.9) !important;
        color: white !important;
        border: 2px solid #00ff88 !important;
        margin-bottom: 15px !important;
        opacity: 1 !important;
        transform: none !important;
        animation: none !important;
    }
    
    /* Rimuovi il CSS di debug */
    /*
    .stars-container,
    .nebula,
    .grid-plane {
        display: none !important;
    }
    */
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)) !important;
    gap: 25px !important;
    margin-top: 30px !important;
    position: relative !important;
    z-index: 1000 !important;
    }
    
    /* Singolo blocco */
    .block-item {
        background: linear-gradient(135deg, rgba(0, 162, 255, 0.1), rgba(0, 255, 136, 0.05)) !important;
        border: 2px solid rgba(0, 255, 136, 0.4) !important;
        border-radius: 15px !important;
        padding: 25px !important;
        cursor: pointer !important;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        position: relative !important;
        overflow: hidden !important;
        backdrop-filter: blur(10px) !important;
        z-index: 1001 !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3),
                    0 0 20px rgba(0, 255, 136, 0.1) !important;
        opacity: 0 !important;
        transform: translateY(30px) !important;
        animation: blockFadeIn 0.6s ease forwards !important;
    }
    
    @keyframes blockFadeIn {
        to {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
    }
    
    .block-item:hover {
        transform: translateY(-8px) scale(1.02) !important;
        border-color: rgba(0, 255, 136, 0.8) !important;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4),
                    0 0 40px rgba(0, 255, 136, 0.3) !important;
        background: linear-gradient(135deg, rgba(0, 162, 255, 0.2), rgba(0, 255, 136, 0.1)) !important;
    }
    
    .block-item.active {
        border-color: rgba(255, 215, 0, 0.8) !important;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.4) !important;
        animation: pulse-glow 2s ease-in-out infinite alternate !important;
    }
    
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
        100% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
    }
    
    .block-item:hover::before {
        content: "" !important;
        position: absolute !important;
        top: 0 !important;
        left: -100% !important;
        width: 100% !important;
        height: 100% !important;
        background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.2), transparent) !important;
        animation: scan-effect 1.5s ease-in-out !important;
    }
    
    @keyframes scan-effect {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    /* Intestazione blocco */
    .block-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 20px !important;
        padding-bottom: 15px !important;
        border-bottom: 1px solid rgba(0, 255, 136, 0.3) !important;
    }
    
    .block-title {
        font-size: 1.4rem !important;
        font-weight: bold !important;
        color: #00ff88 !important;
        font-family: 'Courier New', monospace !important;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5) !important;
    }
    
    .block-status {
        padding: 6px 12px !important;
        border-radius: 20px !important;
        font-size: 0.8rem !important;
        font-weight: bold !important;
        text-transform: uppercase !important;
        letter-spacing: 1px !important;
        background: rgba(0, 255, 136, 0.2) !important;
        color: #00ff88 !important;
        border: 1px solid rgba(0, 255, 136, 0.5) !important;
    }
    
    /* Informazioni blocco */
    .block-info {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 15px !important;
        margin-bottom: 20px !important;
    }
    
    .info-item {
        display: flex !important;
        flex-direction: column !important;
    }
    
    .info-label {
        font-size: 0.8rem !important;
        color: rgba(255, 255, 255, 0.6) !important;
        text-transform: uppercase !important;
        letter-spacing: 1px !important;
        margin-bottom: 5px !important;
    }
    
    .info-value {
        font-size: 1rem !important;
        color: #ffffff !important;
        font-family: 'Courier New', monospace !important;
        font-weight: bold !important;
    }
    
    /* Hash del blocco */
    .block-hash {
        background: rgba(0, 0, 0, 0.5) !important;
        border: 1px solid rgba(0, 162, 255, 0.3) !important;
        border-radius: 8px !important;
        padding: 12px !important;
        font-family: 'Courier New', monospace !important;
        font-size: 0.85rem !important;
        color: rgba(255, 255, 255, 0.8) !important;
        word-break: break-all !important;
        margin-top: 15px !important;
    }
    
    /* Pannello statistiche */
    .blockchain-stats {
        background: rgba(0, 0, 0, 0.6) !important;
        border: 1px solid rgba(0, 255, 136, 0.3) !important;
        border-radius: 15px !important;
        padding: 25px !important;
        margin-bottom: 30px !important;
        backdrop-filter: blur(10px) !important;
    }
    
    .stats-title {
        font-size: 1.3rem !important;
        color: #00ff88 !important;
        font-family: 'Courier New', monospace !important;
        margin-bottom: 20px !important;
        text-align: center !important;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5) !important;
    }
    
    .stats-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
        gap: 20px !important;
    }
    
    .stat-item {
        text-align: center !important;
        padding: 15px !important;
        background: rgba(0, 162, 255, 0.1) !important;
        border-radius: 10px !important;
        border: 1px solid rgba(0, 162, 255, 0.3) !important;
        transition: all 0.3s ease !important;
    }
    
    .stat-item:hover {
        background: rgba(0, 255, 136, 0.1) !important;
        border-color: rgba(0, 255, 136, 0.5) !important;
        transform: translateY(-2px) !important;
    }
    
    .stat-value {
        font-size: 2rem !important;
        font-weight: bold !important;
        color: #00ff88 !important;
        display: block !important;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5) !important;
    }
    
    .stat-label {
        font-size: 0.9rem !important;
        color: rgba(255, 255, 255, 0.8) !important;
        margin-top: 8px !important;
        text-transform: uppercase !important;
        letter-spacing: 1px !important;
    }
    
    /* Stili per il titolo e badge */
    .page-title {
        color: #00ff88 !important;
        text-shadow: 0 0 15px rgba(0,255,136,0.5) !important;
        font-family: 'Courier New', monospace !important;
        font-size: 2.5rem !important;
        text-transform: uppercase !important;
        letter-spacing: 2px !important;
    }
    
    .badge {
        font-family: 'Courier New', monospace !important;
        text-shadow: 0 0 5px rgba(0,0,0,0.5) !important;
        font-size: 1rem !important;
        padding: 8px 15px !important;
    }
    
    /* Navbar override per questa pagina */
    .navbar {
        background-color: rgba(0,0,0,0.9) !important;
        backdrop-filter: blur(15px) !important;
    }
    
    .navbar-brand, .nav-link {
        color: #00ff88 !important;
    }
    
    .nav-link:hover {
        color: #ffffff !important;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .blocks-list {
            grid-template-columns: 1fr !important;
        }
        
        .block-info {
            grid-template-columns: 1fr !important;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr) !important;
        }
        
        .page-title {
            font-size: 1.8rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Sfondo stellare -->
<div class="stars-container">
    <div class="star-layer"></div>
    <div class="star-layer"></div>
    <div class="star-layer"></div>
</div>
<div class="nebula"></div>
<div class="grid-plane"></div>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="page-title">
                    <i class="fas fa-cubes me-3"></i>
                    Blockchain Explorer
                </h2>
                <div>
                    <span class="badge bg-success me-2">{{ blocks|length }} Blocchi</span>
                    <span class="badge bg-info">{{ total_transactions|default:0 }} Transazioni</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="blockchain-container">
                <!-- Stats panel -->
                <div class="blockchain-stats">
                    <div class="stats-title">
                        <i class="fas fa-chart-line me-2"></i>Blockchain Status
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value">{{ blocks|length }}</span>
                            <div class="stat-label">Blocchi Totali</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">#{{ latest_block.index|default:"0" }}</span>
                            <div class="stat-label">Ultimo Blocco</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ total_transactions|default:0 }}</span>
                            <div class="stat-label">Transazioni</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="selected-count">0</span>
                            <div class="stat-label">Selezionati</div>
                        </div>
                    </div>
                </div>
                
                <!-- Lista blocchi -->
                <div class="blocks-list">
                    {% if blocks %}
                        {% for block in blocks %}
                        <div class="block-item" data-block-id="{{ block.id }}" onclick="selectBlock(this)" ondblclick="window.location.href='{% url 'Cripto1:block_detail_view' block.id %}'">
                            <div class="block-header">
                                <div class="block-title">
                                    <i class="fas fa-cube me-2"></i>
                                    Blocco #{{ block.index }}
                                </div>
                                <div class="block-status">Attivo</div>
                            </div>
                            
                            <div class="block-info">
                                <div class="info-item">
                                    <div class="info-label">Transazioni</div>
                                    <div class="info-value">{{ block.transactions.count|default:0 }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Difficoltà</div>
                                    <!-- Rimuovi:
                                    <div class="info-value">{{ block.difficulty|default:"N/A" }}</div>
                                    -->
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Nonce</div>
                                    <div class="info-value">{{ block.nonce|default:"N/A" }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Tempo</div>
                                    <div class="info-value">{{ block.timestamp|date:"H:i:s"|default:"N/A" }}</div>
                                </div>
                            </div>
                            
                            <div class="block-hash">
                                <div class="info-label mb-2">Hash Blocco</div>
                                {{ block.hash|default:"N/A" }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12 text-center" style="color: #00ff88; font-family: 'Courier New', monospace; padding: 50px;">
                            <i class="fas fa-cube" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;"></i>
                            <h3>Nessun blocco trovato</h3>
                            <p style="color: rgba(255,255,255,0.7);">La blockchain è vuota</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedBlocks = new Set();

// Funzione per selezionare/deselezionare un blocco
function selectBlock(element) {
    const blockId = element.getAttribute('data-block-id');
    
    if (selectedBlocks.has(blockId)) {
        selectedBlocks.delete(blockId);
        element.classList.remove('active');
    } else {
        selectedBlocks.add(blockId);
        element.classList.add('active');
    }
    
    // Aggiorna il contatore
    document.getElementById('selected-count').textContent = selectedBlocks.size;
    
    // Mostra toast di selezione
    showSelectionToast(blockId, selectedBlocks.has(blockId));
}

// Funzione per mostrare i dettagli del blocco
function showBlockDetails(blockId) {
    window.location.href = `/blocks/${blockId}/`;
}

// Toast per la selezione
function showSelectionToast(blockId, selected) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: ${selected ? '#00ff88' : '#ff4444'};
        padding: 15px 20px;
        border-radius: 10px;
        border: 2px solid ${selected ? 'rgba(0, 255, 136, 0.5)' : 'rgba(255, 68, 68, 0.5)'};
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        backdrop-filter: blur(15px);
        animation: slideIn 0.4s ease;
        font-family: 'Courier New', monospace;
    `;
    
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${selected ? 'check-circle' : 'times-circle'}"></i>
            <span>Blocco #${blockId} ${selected ? 'selezionato' : 'deselezionato'}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Rimuovi automaticamente dopo 2 secondi
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }
    }, 2000);
}

// Aggiungi stili per l'animazione del toast
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Animazione di entrata scaglionata per i blocchi
document.addEventListener('DOMContentLoaded', function() {
    const blocks = document.querySelectorAll('.block-item');
    blocks.forEach((block, index) => {
        block.style.animationDelay = `${index * 0.1}s`;
    });
});
</script>
/* CSS DI DEBUG - TEMPORANEO */
.blocks-list {
    background: red !important;
    z-index: 9999 !important;
    position: relative !important;
}

.block-item {
    background: yellow !important;
    color: black !important;
    border: 5px solid blue !important;
    z-index: 10000 !important;
    position: relative !important;
    opacity: 1 !important;
    transform: none !important;
    animation: none !important;
}

/* Nascondi temporaneamente gli sfondi */
.stars-container,
.nebula,
.grid-plane {
    display: none !important;
}
</style>

{% endblock %}