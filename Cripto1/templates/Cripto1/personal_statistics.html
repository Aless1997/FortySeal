{% extends 'Cripto1/base.html' %}
{% load static %}

{% block title %}Statistiche Personali - Blockchain App{% endblock %}

{% block content %}
<style>
    .stats-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(0,0,0,0.15);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #007bff;
    }
    
    .stats-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .gradient-bg-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-bg-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .gradient-bg-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .gradient-bg-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .gradient-bg-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .gradient-bg-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    
    .text-white .stats-number,
    .text-white .stats-label {
        color: white !important;
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-line me-2"></i>Statistiche Personali</h2>
        <a href="{% url 'Cripto1:personal_profile' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Torna al Profilo
        </a>
    </div>

    <!-- Statistiche Generali -->
    <div class="row mb-4">
        <div class="col-md-2 col-sm-4 col-6 mb-3">
            <div class="card stats-card gradient-bg-1 text-white text-center p-3">
                <div class="stats-number">{{ total_transactions }}</div>
                <div class="stats-label">Transazioni Totali</div>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-3">
            <div class="card stats-card gradient-bg-2 text-white text-center p-3">
                <div class="stats-number">{{ sent_transactions }}</div>
                <div class="stats-label">Inviate</div>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-3">
            <div class="card stats-card gradient-bg-3 text-white text-center p-3">
                <div class="stats-number">{{ received_transactions }}</div>
                <div class="stats-label">Ricevute</div>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-3">
            <div class="card stats-card gradient-bg-4 text-white text-center p-3">
                <div class="stats-number">{{ encrypted_transactions }}</div>
                <div class="stats-label">Crittografate</div>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-3">
            <div class="card stats-card gradient-bg-5 text-white text-center p-3">
                <div class="stats-number">{{ personal_documents_count }}</div>
                <div class="stats-label">Documenti</div>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 col-6 mb-3">
            <div class="card stats-card gradient-bg-6 text-white text-center p-3">
                <div class="stats-number">{{ total_file_size_mb }}</div>
                <div class="stats-label">MB Totali</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Grafico Tipi di Transazioni -->
        <div class="col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-pie-chart me-2"></i>Tipi di Transazioni</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="transactionTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grafico Attività Mensile -->
        <div class="col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Attività Mensile</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Contatti -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Top Destinatari</h5>
                </div>
                <div class="card-body">
                    {% if sent_to %}
                        {% for contact in sent_to %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span><i class="fas fa-user me-2"></i>{{ contact.receiver__username }}</span>
                            <span class="badge bg-primary">{{ contact.count }} transazioni</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Nessuna transazione inviata ancora.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-inbox me-2"></i>Top Mittenti</h5>
                </div>
                <div class="card-body">
                    {% if received_from %}
                        {% for contact in received_from %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span><i class="fas fa-user me-2"></i>{{ contact.sender__username }}</span>
                            <span class="badge bg-warning">{{ contact.count }} transazioni</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Nessuna transazione ricevuta ancora.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiche Recenti -->
    <div class="row">
        <div class="col-12">
            <div class="card stats-card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Attività Recente (Ultimo Mese)</h5>
                </div>
                <div class="card-body text-center">
                    <div class="stats-number text-primary">{{ recent_transactions }}</div>
                    <div class="stats-label">Transazioni negli ultimi 30 giorni</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nuova Sezione: Analisi Sicurezza -->
    <div class="row mt-4">
        <div class="col-md-4 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Sicurezza</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-lock me-2"></i>Transazioni Crittografate</span>
                        <span class="badge bg-success">{{ encrypted_percentage }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-key me-2"></i>Chiavi Attive</span>
                        <span class="badge bg-info">RSA 2048</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-download me-2"></i>Download Sicuri</span>
                        <span class="badge bg-primary">{{ secure_downloads }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-purple text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;">
                    <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Tendenze</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-arrow-up me-2 text-success"></i>Crescita Mensile</span>
                        <span class="badge bg-success">+{{ growth_percentage }}%</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-calendar-day me-2"></i>Media Giornaliera</span>
                        <span class="badge bg-info">{{ daily_average }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-fire me-2 text-warning"></i>Giorno più Attivo</span>
                        <span class="badge bg-warning">{{ most_active_day }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <!--<div class="card stats-card">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important;">
                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Achievements</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-medal me-2 text-warning"></i>Prima Transazione</span>
                        <span class="badge bg-secondary">{{ first_transaction_date }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-star me-2 text-warning"></i>Milestone 100</span>
                        <span class="badge {% if total_transactions >= 100 %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if total_transactions >= 100 %}Raggiunto!{% else %}{{ total_transactions }}/100{% endif %}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-crown me-2 text-warning"></i>Utente Attivo</span>
                        <span class="badge {% if recent_transactions > 10 %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if recent_transactions > 10 %}Sì{% else %}No{% endif %}
                        </span>
                    </div>
                </div>
            </div>-->
        </div>
    </div>

    <!-- Grafico Timeline Attività -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card stats-card">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Timeline Attività (Ultimi 7 Giorni)</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="weeklyTimelineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiche Storage -->
    <div class="row mt-4">
        <div class="col-12 mb-3">
            <h4><i class="fas fa-hdd me-2"></i>Statistiche Storage</h4>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="card stats-card gradient-bg-1 text-white text-center p-3">
                <div class="stats-number">{{ total_storage_mb }}</div>
                <div class="stats-label">MB Utilizzati</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="card stats-card gradient-bg-2 text-white text-center p-3">
                <div class="stats-number">{{ storage_limit_mb }}</div>
                <div class="stats-label">MB Limite</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="card stats-card gradient-bg-3 text-white text-center p-3">
                <div class="stats-number">{{ storage_percentage }}%</div>
                <div class="stats-label">Storage Usato</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="card stats-card gradient-bg-4 text-white text-center p-3">
                <div class="stats-number">{{ remaining_storage_mb }}</div>
                <div class="stats-label">MB Disponibili</div>
            </div>
        </div>
    </div>

    <!-- Dettagli Storage per Tipo -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Distribuzione Storage</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="storageDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Dettagli per Categoria</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-file-alt me-2"></i>Documenti Personali</span>
                        <span class="badge bg-primary">{{ personal_docs_storage_mb }} MB</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-paper-plane me-2"></i>File Transazioni</span>
                        <span class="badge bg-success">{{ transaction_files_storage_mb }} MB</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-image me-2"></i>Immagini</span>
                        <span class="badge bg-info">{{ images_storage_mb }} MB</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span><i class="fas fa-file-pdf me-2"></i>PDF</span>
                        <span class="badge bg-danger">{{ pdf_storage_mb }} MB</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-file me-2"></i>Altri File</span>
                        <span class="badge bg-secondary">{{ other_files_storage_mb }} MB</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra di Progresso Storage -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card stats-card">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;">
                    <h5 class="mb-0"><i class="fas fa-battery-three-quarters me-2"></i>Utilizzo Storage</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Spazio Utilizzato</span>
                            <span><strong>{{ total_storage_mb }} MB / {{ storage_limit_mb }} MB</strong></span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar {% if storage_percentage > 80 %}bg-danger{% elif storage_percentage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ storage_percentage }}%" 
                                 aria-valuenow="{{ storage_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ storage_percentage }}%
                            </div>
                        </div>
                    </div>
                    
                    {% if storage_percentage > 80 %}
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Attenzione:</strong> Stai utilizzando oltre l'80% dello spazio disponibile. Considera di eliminare alcuni file non necessari.
                    </div>
                    {% elif storage_percentage > 90 %}
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Spazio quasi esaurito:</strong> Hai utilizzato oltre il 90% dello spazio. Elimina alcuni file per continuare a caricare nuovi contenuti.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Top File più Grandi -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-weight-hanging me-2"></i>File più Grandi</h5>
                </div>
                <div class="card-body">
                    {% if largest_files %}
                        {% for file in largest_files %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-file me-2"></i>
                                <span class="text-truncate" style="max-width: 200px;">{{ file.name }}</span>
                            </div>
                            <span class="badge bg-primary">{{ file.size_mb }} MB</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Nessun file caricato ancora.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card stats-card">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important;">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>File Recenti</h5>
                </div>
                <div class="card-body">
                    {% if recent_files %}
                        {% for file in recent_files %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-file me-2"></i>
                                <span class="text-truncate" style="max-width: 200px;">{{ file.name }}</span>
                            </div>
                            <small class="text-muted">{{ file.upload_date|date:"d/m/Y" }}</small>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Nessun file caricato di recente.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Grafico a torta per i tipi di transazioni
    const typeCtx = document.getElementById('transactionTypeChart').getContext('2d');
    new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: ['Messaggi di Testo', 'File'],
            datasets: [{
                data: [{{ text_transactions }}, {{ file_transactions }}],
                backgroundColor: ['#36A2EB', '#FF6384'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Grafico a barre per l'attività mensile
    const monthlyCtx = document.getElementById('monthlyActivityChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: [{% for stat in monthly_stats %}'{{ stat.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Transazioni',
                data: [{% for stat in monthly_stats %}{{ stat.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Nuovo grafico timeline settimanale
    const weeklyCtx = document.getElementById('weeklyTimelineChart').getContext('2d');
    new Chart(weeklyCtx, {
        type: 'line',
        data: {
            labels: ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'],
            datasets: [{
                label: 'Transazioni Inviate',
                data: [{{ weekly_sent.0 }}, {{ weekly_sent.1 }}, {{ weekly_sent.2 }}, {{ weekly_sent.3 }}, {{ weekly_sent.4 }}, {{ weekly_sent.5 }}, {{ weekly_sent.6 }}],
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Transazioni Ricevute',
                data: [{{ weekly_received.0 }}, {{ weekly_received.1 }}, {{ weekly_received.2 }}, {{ weekly_received.3 }}, {{ weekly_received.4 }}, {{ weekly_received.5 }}, {{ weekly_received.6 }}],
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });

    // Grafico distribuzione storage
    const storageCtx = document.getElementById('storageDistributionChart').getContext('2d');
    new Chart(storageCtx, {
        type: 'doughnut',
        data: {
            labels: ['Documenti Personali', 'File Transazioni', 'Immagini', 'PDF', 'Altri File'],
            datasets: [{
                data: [
                    {{ personal_docs_storage_mb }}, 
                    {{ transaction_files_storage_mb }}, 
                    {{ images_storage_mb }}, 
                    {{ pdf_storage_mb }}, 
                    {{ other_files_storage_mb }}
                ],
                backgroundColor: [
                    '#36A2EB',
                    '#4BC0C0', 
                    '#FF6384',
                    '#FF9F40',
                    '#9966FF'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>
{% endblock %}