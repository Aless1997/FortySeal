{% extends 'Cripto1/base.html' %}
{% load static %}

{% block title %}Statistiche Personali - Blockchain App{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        border: none;
        border-radius: 16px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .stats-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }
    
    .section-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: white;
    }
    
    .section-card:hover {
        border-color: #d1d5db;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .progress-modern {
        height: 12px;
        border-radius: 6px;
        background-color: #f3f4f6;
        overflow: hidden;
    }
    
    .progress-bar-modern {
        border-radius: 6px;
        transition: width 0.8s ease;
        position: relative;
    }
    
    .storage-indicator {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
    }
    
    .storage-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    .metric-item {
        padding: 1rem;
        border-radius: 8px;
        background: #f9fafb;
        border: 1px solid #f3f4f6;
        transition: all 0.2s ease;
    }
    
    .metric-item:hover {
        background: #f3f4f6;
        border-color: #e5e7eb;
    }
    
    .file-item {
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid #f3f4f6;
        transition: all 0.2s ease;
        margin-bottom: 0.5rem;
    }
    
    .file-item:hover {
        background-color: #f9fafb;
        border-color: #d1d5db;
    }
    
    .chart-container {
        position: relative;
        height: 280px;
        margin: 20px 0;
    }
    
    .text-primary { color: #3b82f6 !important; }
    .text-success { color: #10b981 !important; }
    .text-info { color: #06b6d4 !important; }
    .text-warning { color: #f59e0b !important; }
    .text-danger { color: #ef4444 !important; }
    .text-secondary { color: #6b7280 !important; }
    .text-muted { color: #9ca3af !important; }
    
    .bg-primary { background-color: #3b82f6 !important; }
    .bg-success { background-color: #10b981 !important; }
    .bg-info { background-color: #06b6d4 !important; }
    .bg-warning { background-color: #f59e0b !important; }
    .bg-danger { background-color: #ef4444 !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h3 mb-1 text-gray-800">Statistiche Personali</h2>
                    <p class="text-muted mb-0">Panoramica completa della tua attivit√†</p>
                </div>
                <a href="{% url 'Cripto1:personal_profile' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Torna al Profilo
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiche Generali -->
    <div class="row mb-4">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-exchange-alt stats-icon text-primary mb-3"></i>
                    <h4 class="mb-1">{{ total_transactions }}</h4>
                    <p class="text-muted mb-0 small">Transazioni Totali</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-paper-plane stats-icon text-success mb-3"></i>
                    <h4 class="mb-1">{{ sent_transactions }}</h4>
                    <p class="text-muted mb-0 small">Inviate</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-inbox stats-icon text-info mb-3"></i>
                    <h4 class="mb-1">{{ received_transactions }}</h4>
                    <p class="text-muted mb-0 small">Ricevute</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-lock stats-icon text-warning mb-3"></i>
                    <h4 class="mb-1">{{ encrypted_transactions }}</h4>
                    <p class="text-muted mb-0 small">Crittografate</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-file-alt stats-icon text-secondary mb-3"></i>
                    <h4 class="mb-1">{{ personal_documents_count }}</h4>
                    <p class="text-muted mb-0 small">Documenti Personali</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-database stats-icon text-danger mb-3"></i>
                    <h4 class="mb-1">{{ total_storage_mb|floatformat:1 }}</h4>
                    <p class="text-muted mb-0 small">MB Totali</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Storage Section -->
        <div class="col-lg-6 mb-4">
            <div class="card section-card h-100">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0">Utilizzo Storage</h5>
                </div>
                <div class="card-body">
                    <div class="storage-indicator mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="storage-icon me-3">
                                <i class="fas fa-hdd"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-medium">{{ used_storage_mb|floatformat:1 }} MB utilizzati</span>
                                    <span class="text-muted small">{{ storage_percentage|floatformat:1 }}%</span>
                                </div>
                                <div class="progress-modern">
                                    <div class="progress-bar-modern {% if storage_percentage > 90 %}bg-danger{% elif storage_percentage > 80 %}bg-warning{% else %}bg-primary{% endif %}" 
                                         style="width: {{ storage_percentage }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="metric-item">
                                    <div class="small text-muted">Limite</div>
                                    <div class="fw-medium">{{ storage_limit_mb }} MB</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="metric-item">
                                    <div class="small text-muted">Utilizzato</div>
                                    <div class="fw-medium">{{ used_storage_mb|floatformat:1 }} MB</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="metric-item">
                                    <div class="small text-muted">Disponibile</div>
                                    <div class="fw-medium">{{ available_storage_mb|floatformat:1 }} MB</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if storage_percentage > 90 %}
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Attenzione!</strong> Hai superato il 90% del limite di storage.
                        </div>
                    {% elif storage_percentage > 80 %}
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Avviso:</strong> Hai superato l'80% del limite di storage.
                        </div>
                    {% endif %}

                    <!-- Distribuzione Storage -->
                    <div class="mt-4">
                        <h6 class="mb-3">Distribuzione per Categoria</h6>
                        <div class="chart-container">
                            <canvas id="storageDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grafici Attivit√† -->
        <div class="col-lg-6 mb-4">
            <div class="card section-card h-100">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0">Analisi Attivit√†</h5>
                </div>
                <div class="card-body">
                    <!-- Tipi di Transazioni -->
                    <div class="mb-4">
                        <h6 class="mb-3">Tipi di Transazioni</h6>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="transactionTypeChart"></canvas>
                        </div>
                    </div>

                    <!-- Attivit√† Settimanale -->
                    <div class="mt-4">
                        <h6 class="mb-3">Attivit√† Settimanale</h6>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="weeklyTimelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attivit√† Mensile -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card section-card">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0">Attivit√† Mensile</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyActivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Management -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card section-card h-100">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0">File Pi√π Grandi</h5>
                </div>
                <div class="card-body">
                    {% if largest_files %}
                        {% for file in largest_files %}
                            <div class="file-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file me-3 text-muted"></i>
                                    <div>
                                        <div class="fw-medium">{{ file.name|truncatechars:30 }}</div>
                                        <small class="text-muted">{{ file.upload_date|date:"d M Y" }}</small>
                                    </div>
                                </div>
                                <span class="badge bg-light text-dark">{{ file.size_mb|floatformat:2 }} MB</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">Nessun file trovato.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card section-card h-100">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0">File Recenti</h5>
                </div>
                <div class="card-body">
                    {% if recent_files %}
                        {% for file in recent_files %}
                            <div class="file-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file me-3 text-muted"></i>
                                    <div>
                                        <div class="fw-medium">{{ file.name|truncatechars:30 }}</div>
                                        <small class="text-muted">{{ file.upload_date|date:"d M Y H:i" }}</small>
                                    </div>
                                </div>
                                <span class="badge bg-light text-dark">{{ file.size_mb|floatformat:2 }} MB</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-history fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">Nessun file caricato di recente.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Definizione colori
    const colors = {
        primary: '#3b82f6',
        success: '#10b981',
        info: '#06b6d4',
        warning: '#f59e0b',
        danger: '#ef4444',
        secondary: '#6b7280',
        light: '#f8fafc',
        dark: '#1f2937'
    };

    // Grafico a torta per i tipi di transazioni
    const typeCtx = document.getElementById('transactionTypeChart');
    if (typeCtx) {
        new Chart(typeCtx, {
            type: 'doughnut',
            data: {
                labels: ['Messaggi di Testo', 'File'],
                datasets: [{
                    data: [{{ text_transactions }}, {{ file_transactions }}],
                    backgroundColor: [colors.primary, colors.success],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: { size: 11 }
                        }
                    }
                },
                cutout: '65%'
            }
        });
    }

    // Grafico a barre per l'attivit√† mensile
    const monthlyCtx = document.getElementById('monthlyActivityChart');
    if (monthlyCtx) {
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: [{% for stat in monthly_stats %}'{{ stat.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                datasets: [{
                    label: 'Transazioni',
                    data: [{% for stat in monthly_stats %}{{ stat.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    backgroundColor: colors.success + '20',
                    borderColor: colors.success,
                    borderWidth: 2,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                        grid: { color: '#f3f4f6' }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Grafico timeline settimanale
    const weeklyCtx = document.getElementById('weeklyTimelineChart');
    if (weeklyCtx) {
        new Chart(weeklyCtx, {
            type: 'line',
            data: {
                labels: ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'],
                datasets: [{
                    label: 'Inviate',
                    data: [{{ weekly_sent.0 }}, {{ weekly_sent.1 }}, {{ weekly_sent.2 }}, {{ weekly_sent.3 }}, {{ weekly_sent.4 }}, {{ weekly_sent.5 }}, {{ weekly_sent.6 }}],
                    borderColor: colors.primary,
                    backgroundColor: colors.primary + '10',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: colors.primary,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }, {
                    label: 'Ricevute',
                    data: [{{ weekly_received.0 }}, {{ weekly_received.1 }}, {{ weekly_received.2 }}, {{ weekly_received.3 }}, {{ weekly_received.4 }}, {{ weekly_received.5 }}, {{ weekly_received.6 }}],
                    borderColor: colors.info,
                    backgroundColor: colors.info + '10',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: colors.info,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                        grid: { color: '#f3f4f6' }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: { size: 11 }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    // Grafico distribuzione storage
    const storageCtx = document.getElementById('storageDistributionChart');
    if (storageCtx) {
        new Chart(storageCtx, {
            type: 'doughnut',
            data: {
                labels: ['Documenti Personali', 'File Transazioni', 'Immagini', 'PDF', 'Altri'],
                datasets: [{
                    data: [
                        {{ storage_by_category.personal_documents|default:0 }},
                        {{ storage_by_category.transaction_files|default:0 }},
                        {{ storage_by_category.images|default:0 }},
                        {{ storage_by_category.pdf|default:0 }},
                        {{ storage_by_category.others|default:0 }}
                    ],
                    backgroundColor: [
                        colors.primary,
                        colors.success,
                        colors.info,
                        colors.warning,
                        colors.secondary
                    ],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: { size: 10 }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }

    // Animazione progress bar
    document.addEventListener('DOMContentLoaded', function() {
        const progressBar = document.querySelector('.progress-bar-modern');
        if (progressBar) {
            const targetWidth = progressBar.style.width;
            progressBar.style.width = '0%';
            
            setTimeout(() => {
                progressBar.style.width = targetWidth;
            }, 300);
        }
    });
</script>
{% endblock %}