{% extends 'Cripto1/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Gestore File - FortySeal{% endblock %}

{% block extra_css %}
<style>
    /* Stile moderno ispirato a personal_profile.html */
    .file-manager-container {
        min-height: 600px;
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 30px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
    }
    
    /* Header moderno */
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }
    
    .page-header h2 {
        color: white;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        position: relative;
        z-index: 1;
    }
    
    /* Card moderne per categorie */
    .category-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.1);
        overflow: hidden;
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
        cursor: pointer;
        height: 100%;
        background: white;
    }
    
    .category-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(79, 70, 229, 0.05) 100%);
        z-index: -1;
        transition: opacity 0.3s ease;
        opacity: 0;
    }
    
    .category-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(99, 102, 241, 0.2);
    }
    
    .category-card:hover::before {
        opacity: 1;
    }
    
    .category-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .category-header::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
        transform: translateX(-100%);
        transition: all 0.3s ease;
    }
    
    .category-card:hover .category-header::after {
        transform: translateX(100%);
    }
    
    .emoji-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        display: block;
        animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-10px);
        }
        60% {
            transform: translateY(-5px);
        }
    }
    
    /* File cards moderne */
    .file-card {
        transition: all 0.3s ease;
        animation: fadeInUp 0.6s ease-out;
    }
    
    .file-card:nth-child(1) { animation-delay: 0.1s; }
    .file-card:nth-child(2) { animation-delay: 0.2s; }
    .file-card:nth-child(3) { animation-delay: 0.3s; }
    .file-card:nth-child(4) { animation-delay: 0.4s; }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .file-card .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.1);
        overflow: hidden;
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
        background: white;
    }
    
    .file-card .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(79, 70, 229, 0.05) 100%);
        z-index: -1;
        transition: opacity 0.3s ease;
        opacity: 0;
    }
    
    .file-card .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(99, 102, 241, 0.2);
    }
    
    .file-card .card:hover::before {
        opacity: 1;
    }
    
    .file-icon {
        font-size: 2.5rem;
        margin-right: 1rem;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transition: all 0.3s ease;
    }
    
    .file-card:hover .file-icon {
        transform: scale(1.1) rotate(5deg);
    }
    
    /* Filtri moderni */
    .filter-section {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.1);
        backdrop-filter: blur(10px);
    }
    
    .file-type-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 1rem;
    }
    
    .file-type-badge {
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f8f9fa;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .file-type-badge::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: all 0.3s ease;
    }
    
    .file-type-badge:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .file-type-badge:hover::before {
        left: 100%;
    }
    
    .file-type-badge.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        transform: translateY(-2px);
    }
    
    /* Area di upload moderna */
    .upload-area {
        border: 3px dashed #667eea;
        border-radius: 16px;
        padding: 3rem;
        text-align: center;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        position: relative;
        overflow: hidden;
    }
    
    .upload-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(102, 126, 234, 0.1) 50%, transparent 70%);
        transform: translateX(-100%);
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #764ba2;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        transform: translateY(-2px);
    }
    
    .upload-area:hover::before {
        transform: translateX(100%);
    }
    
    .upload-area.dragover {
        border-color: #4facfe;
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.2) 0%, rgba(0, 242, 254, 0.2) 100%);
        transform: scale(1.02);
    }
    
    /* Stato vuoto animato */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 16px;
        margin: 2rem 0;
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.1);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.1);
        }
        50% {
            box-shadow: 0 15px 35px rgba(99, 102, 241, 0.2);
        }
        100% {
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.1);
        }
    }
    
    .empty-state-icon {
        font-size: 6rem;
        margin-bottom: 2rem;
        color: #667eea;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
    }
    
    /* Bottoni moderni */
    .btn-modern {
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    
    .btn-modern::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.2);
        z-index: -1;
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.5s ease;
    }
    
    .btn-modern:hover::after {
        transform: scaleX(1);
        transform-origin: left;
    }
    
    .btn-primary-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
    }
    
    .btn-success-modern {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        color: white;
    }
    
    .btn-danger-modern {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        border: none;
        color: white;
    }
    
    /* Modal moderni */
    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        overflow: hidden;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: none;
        padding: 1.5rem;
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .modal-footer {
        border-top: none;
        padding: 1.5rem;
        background: #f8f9fa;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .category-card {
            margin-bottom: 1rem;
        }
        
        .file-type-filter {
            justify-content: center;
        }
        
        .upload-area {
            padding: 2rem;
        }
    }
    
    /* Scrollbar personalizzata */
    ::-webkit-scrollbar {
        width: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header moderno -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-0">
                    <i class="fas fa-folder-open me-3"></i> Gestore File
                    <small class="d-block mt-2 opacity-75">Gestisci i file del sistema in modo semplice e sicuro</small>
                </h2>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'Cripto1:admin_dashboard' %}" class="btn btn-light btn-modern">
                    <i class="fas fa-arrow-left me-2"></i> Dashboard
                </a>
            </div>
        </div>
    </div>

    {% if messages %}
        <div class="row">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="border-radius: 16px;">
                        <div class="d-flex align-items-center">
                            {% if message.tags == 'success' %}
                                <i class="fas fa-check-circle me-2 text-success"></i>
                            {% elif message.tags == 'error' or message.tags == 'danger' %}
                                <i class="fas fa-exclamation-circle me-2 text-danger"></i>
                            {% elif message.tags == 'warning' %}
                                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                            {% elif message.tags == 'info' %}
                                <i class="fas fa-info-circle me-2 text-info"></i>
                            {% endif %}
                            {{ message }}
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <!-- Visualizzazione principale: Categorie come card -->
    {% if not current_category %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-success-modern btn-modern" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-upload me-2"></i> Carica File
                </button>
                <button type="button" class="btn btn-primary-modern btn-modern" data-bs-toggle="modal" data-bs-target="#createFolderModal">
                    <i class="fas fa-folder-plus me-2"></i> Nuova Cartella
                </button>
            </div>
        </div>
    </div>
    
    <div class="row">
        {% for category_key, category_info in categories.items %}
        <div class="col-md-4 col-lg-3 mb-4">
            <div class="card category-card" onclick="window.location.href='?category={{ category_key }}'">
                <div class="category-header">
                    <h4 class="mb-0">{{ category_info.name }}</h4>
                </div>
                <div class="card-body text-center p-4">
                    <div class="emoji-icon">
                        {% if category_key == 'profile_pics' %}
                            üë§
                        {% elif category_key == 'personal_documents' %}
                            üìÑ
                        {% elif category_key == 'transaction_files' %}
                            üí∞
                        {% else %}
                            üìÅ
                        {% endif %}
                    </div>
                    <p class="card-text text-muted">{{ category_info.description|default:"Gestisci i tuoi file" }}</p>
                </div>
                <div class="card-footer bg-transparent text-center border-0 pb-3">
                    {% with files_count=category_files|get_item:category_key|get_item:'files'|length %}
                    <span class="badge bg-primary rounded-pill px-3 py-2 fs-6">{{ files_count }} file</span>
                    {% endwith %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Visualizzazione dettaglio categoria -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="mb-3">
                <a href="{% url 'Cripto1:file_manager' %}" class="btn btn-outline-primary btn-modern">
                    <i class="fas fa-arrow-left me-2"></i> Torna alle Categorie
                </a>
            </div>
            
            <div class="filter-section">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <form method="get" class="d-flex gap-2">
                            <input type="hidden" name="category" value="{{ current_category }}">
                            <input type="text" name="search" class="form-control rounded-pill" placeholder="üîç Cerca file..." value="{{ search_query }}">
                            <button type="submit" class="btn btn-primary-modern btn-modern rounded-circle">
                                <i class="fas fa-search"></i>
                            </button>
                            {% if search_query %}
                                <a href="?category={{ current_category }}" class="btn btn-outline-secondary btn-modern rounded-circle">
                                    <i class="fas fa-times"></i>
                                </a>
                            {% endif %}
                        </form>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-success-modern btn-modern me-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload me-2"></i> Carica File
                        </button>
                        <button type="button" class="btn btn-primary-modern btn-modern" data-bs-toggle="modal" data-bs-target="#createFolderModal">
                            <i class="fas fa-folder-plus me-2"></i> Nuova Cartella
                        </button>
                    </div>
                </div>
                
                <!-- Filtri per tipo di file -->
                <div class="mt-4">
                    <h6 class="mb-3 fw-bold">Filtra per tipo:</h6>
                    <div class="file-type-filter">
                        <span class="badge file-type-badge active" data-filter="all">
                            <i class="fas fa-layer-group"></i> Tutti
                        </span>
                        <span class="badge file-type-badge" data-filter="image">
                            <i class="fas fa-image"></i> Immagini
                        </span>
                        <span class="badge file-type-badge" data-filter="pdf">
                            <i class="fas fa-file-pdf"></i> PDF
                        </span>
                        <span class="badge file-type-badge" data-filter="doc">
                            <i class="fas fa-file-word"></i> Word
                        </span>
                        <span class="badge file-type-badge" data-filter="excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </span>
                        <span class="badge file-type-badge" data-filter="archive">
                            <i class="fas fa-file-archive"></i> Archivi
                        </span>
                        <span class="badge file-type-badge" data-filter="folder">
                            <i class="fas fa-folder"></i> Cartelle
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="file-manager-container">
        <div class="row" id="fileContainer">
            {% with current_files=category_files|get_item:current_category|get_item:'files' %}
                {% if current_files %}
                    {% for file in current_files %}
                        <div class="col-md-3 mb-4 file-card" 
                             data-type="{% if file.is_dir %}folder{% elif file.name|lower|endswith:'.jpg' or file.name|lower|endswith:'.jpeg' or file.name|lower|endswith:'.png' or file.name|lower|endswith:'.gif' %}image{% elif file.name|lower|endswith:'.pdf' %}pdf{% elif file.name|lower|endswith:'.doc' or file.name|lower|endswith:'.docx' %}doc{% elif file.name|lower|endswith:'.xls' or file.name|lower|endswith:'.xlsx' %}excel{% elif file.name|lower|endswith:'.zip' or file.name|lower|endswith:'.rar' %}archive{% else %}other{% endif %}">
                            <div class="card h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="file-icon">
                                            {% if file.is_dir %}
                                                <i class="fas fa-folder"></i>
                                            {% else %}
                                                {% if file.name|lower|endswith:'.jpg' or file.name|lower|endswith:'.jpeg' or file.name|lower|endswith:'.png' or file.name|lower|endswith:'.gif' %}
                                                    <i class="fas fa-image"></i>
                                                {% elif file.name|lower|endswith:'.pdf' %}
                                                    <i class="fas fa-file-pdf"></i>
                                                {% elif file.name|lower|endswith:'.doc' or file.name|lower|endswith:'.docx' %}
                                                    <i class="fas fa-file-word"></i>
                                                {% elif file.name|lower|endswith:'.xls' or file.name|lower|endswith:'.xlsx' %}
                                                    <i class="fas fa-file-excel"></i>
                                                {% elif file.name|lower|endswith:'.zip' or file.name|lower|endswith:'.rar' %}
                                                    <i class="fas fa-file-archive"></i>
                                                {% else %}
                                                    <i class="fas fa-file"></i>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="file-details flex-grow-1">
                                            <h6 class="mb-1 text-truncate fw-bold">{{ file.name }}</h6>
                                            <small class="text-muted">{{ file.size }} - {{ file.modified }}</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-0 pt-0">
                                    <div class="btn-group btn-group-sm w-100">
                                        {% if file.is_dir %}
                                            <a href="?category={{ current_category }}&folder={{ file.path }}" class="btn btn-outline-primary rounded-start">
                                                <i class="fas fa-folder-open me-1"></i> Apri
                                            </a>
                                        {% else %}
                                            <a href="{{ file.url }}" target="_blank" class="btn btn-outline-primary rounded-start">
                                                <i class="fas fa-eye me-1"></i> Visualizza
                                            </a>
                                        {% endif %}
                                        <button type="button" class="btn btn-outline-danger rounded-end delete-btn" 
                                                data-file-path="{{ file.path|escapejs }}" 
                                                data-file-name="{{ file.name|escapejs }}"
                                                style="cursor: pointer;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÇ</div>
                            <h4 class="mb-3">Nessun file trovato</h4>
                            <p class="text-muted mb-4">Questa categoria √® vuota. Carica alcuni file per iniziare.</p>
                            <button type="button" class="btn btn-primary-modern btn-modern" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fas fa-upload me-2"></i> Carica File
                            </button>
                        </div>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal per il caricamento dei file -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="upload_file" value="1">
                
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">
                        <i class="fas fa-cloud-upload-alt me-2"></i> Carica File
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="category" class="form-label fw-bold">Categoria</label>
                        <select name="category" id="category" class="form-select" required>
                            <option value="">Seleziona una categoria</option>
                            {% for category_key, category_info in categories.items %}
                                <option value="{{ category_key }}" {% if current_category == category_key %}selected{% endif %}>
                                    {{ category_info.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subfolder" class="form-label fw-bold">Sottocartella (opzionale)</label>
                        <input type="text" name="subfolder" id="subfolder" class="form-control">
                        <small class="text-muted">Lascia vuoto per caricare nella cartella principale della categoria</small>
                    </div>
                    <div class="mb-3">
                        <label for="files" class="form-label fw-bold">File</label>
                        <input type="file" name="files" id="files" class="form-control" multiple required>
                    </div>
                    <div class="upload-area" id="dropArea">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                        <p class="mb-0 fw-bold">Trascina i file qui o clicca per selezionarli</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-modern" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary-modern btn-modern">
                        <i class="fas fa-upload me-2"></i> Carica
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal per la creazione di cartelle -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="create_folder" value="1">
                
                <div class="modal-header">
                    <h5 class="modal-title" id="createFolderModalLabel">
                        <i class="fas fa-folder-plus me-2"></i> Nuova Cartella
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="folder_category" class="form-label fw-bold">Categoria</label>
                        <select name="category" id="folder_category" class="form-select" required>
                            <option value="">Seleziona una categoria</option>
                            {% for category_key, category_info in categories.items %}
                                <option value="{{ category_key }}" {% if current_category == category_key %}selected{% endif %}>
                                    {{ category_info.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="parent_folder" class="form-label fw-bold">Cartella Padre (opzionale)</label>
                        <input type="text" name="parent_folder" id="parent_folder" class="form-control">
                        <small class="text-muted">Lascia vuoto per creare nella cartella principale della categoria</small>
                    </div>
                    <div class="mb-3">
                        <label for="folder_name" class="form-label fw-bold">Nome Cartella</label>
                        <input type="text" name="folder_name" id="folder_name" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-modern" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary-modern btn-modern">
                        <i class="fas fa-check me-2"></i> Crea Cartella
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal di conferma eliminazione -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="delete_file" value="1">
                <input type="hidden" name="file_path" id="delete_file_path">
                <input type="hidden" name="category" value="{{ current_category }}">
                
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="fas fa-trash-alt me-2"></i> Conferma Eliminazione
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                        <p class="mb-1">Sei sicuro di voler eliminare <span id="delete_file_name" class="fw-bold"></span>?</p>
                        <p class="text-danger mb-0">Questa azione non pu√≤ essere annullata.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-modern" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i> Annulla
                    </button>
                    <button type="submit" class="btn btn-danger-modern btn-modern">
                        <i class="fas fa-trash-alt me-2"></i> Elimina
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Funzione per confermare l'eliminazione
    function confirmDelete(filePath, fileName) {
        console.log('confirmDelete chiamata con:', { filePath, fileName });
        
        // Decodifica le sequenze Unicode (come u005C -> \)
        try {
            // Gestisci le sequenze Unicode come u005C
            if (filePath.includes('u005C')) {
                filePath = filePath.replace(/u005C/g, '\\');
                console.log('Percorso dopo sostituzione u005C:', filePath);
            }
            
            // Decodifica URL se necessario
            if (filePath.includes('%')) {
                filePath = decodeURIComponent(filePath);
                console.log('Percorso decodificato URL:', filePath);
            }
        } catch (e) {
            console.log('Errore nella decodifica:', e);
        }
        
        // Normalizza il percorso
        filePath = filePath.replace(/\\/g, '/').replace(/\/\//g, '/');
        if (filePath.startsWith('/')) {
            filePath = filePath.substring(1);
        }
        
        // Rimuovi caratteri non validi
        const originalPath = filePath;
        filePath = filePath.replace(/[^\x00-\x7F]/g, '');
        
        if (originalPath !== filePath) {
            console.log('Percorso pulito da caratteri non validi:', originalPath, '->', filePath);
        }
        
        console.log('Percorso finale:', filePath);
        
        // Imposta i valori nel modal
        const pathInput = document.getElementById('delete_file_path');
        const nameSpan = document.getElementById('delete_file_name');
        
        if (pathInput && nameSpan) {
            pathInput.value = filePath;
            nameSpan.textContent = fileName;
            
            // Mostra il modal
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        } else {
            console.error('Elementi del modal non trovati');
        }
    }
    
    // Inizializzazione quando il DOM √® caricato
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded eseguito');
        
        // Event listener per i pulsanti elimina
        const deleteButtons = document.querySelectorAll('.delete-btn');
        console.log('Pulsanti elimina trovati:', deleteButtons.length);
        
        deleteButtons.forEach((button, index) => {
            console.log('Aggiungendo event listener al pulsante', index);
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const filePath = this.getAttribute('data-file-path');
                const fileName = this.getAttribute('data-file-name');
                
                console.log('Pulsante elimina cliccato:', { filePath, fileName });
                
                if (filePath && fileName) {
                    confirmDelete(filePath, fileName);
                } else {
                    console.error('Dati mancanti per eliminazione');
                }
            });
        });
        
        // Controllo per il form di eliminazione
        const deleteForm = document.querySelector('#deleteModal form');
        if (deleteForm) {
            deleteForm.addEventListener('submit', function(e) {
                const filePath = document.getElementById('delete_file_path').value;
                const category = document.querySelector('#deleteModal input[name="category"]').value;
                
                console.log('Invio form di eliminazione:', { filePath, category });
                
                if (!filePath) {
                    e.preventDefault();
                    alert('Errore: percorso del file non specificato');
                    return false;
                }
                
                if (!category) {
                    e.preventDefault();
                    alert('Errore: categoria non specificata');
                    return false;
                }
                
                // Verifica che il percorso non contenga caratteri non validi
                if (/[^\x00-\x7F]/.test(filePath)) {
                    e.preventDefault();
                    alert('Errore: percorso del file contiene caratteri non validi');
                    return false;
                }
                
                console.log('Form di eliminazione valido, invio...');
            });
        }
        
        // Animazioni per le card delle categorie
        const categoryCards = document.querySelectorAll('.category-card');
        categoryCards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('animate__animated', 'animate__fadeInUp');
        });
        
        // Animazioni per i file cards
        const fileCards = document.querySelectorAll('.file-card');
        fileCards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.05}s`;
        });
        
        // Effetto hover per i bottoni moderni
        const buttons = document.querySelectorAll('.btn-modern');
        buttons.forEach(button => {
            button.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px) scale(1.02)';
            });
            
            button.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });
        
        // Effetto ripple per i bottoni
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    pointer-events: none;
                `;
                
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });
        
        // Aggiungi stile per l'animazione ripple
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Drag and drop per il caricamento dei file
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('files');
        
        if (dropArea && fileInput) {
            // Apri il selettore di file quando si clicca sull'area di drop
            dropArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Mostra i file selezionati
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    let fileNames = Array.from(this.files).map(file => file.name).join(', ');
                    dropArea.innerHTML = `
                        <i class="fas fa-check-circle fa-3x mb-3 text-success animate__animated animate__bounceIn"></i>
                        <p class="fw-bold">${this.files.length} file selezionati: ${fileNames}</p>
                    `;
                } else {
                    dropArea.innerHTML = `
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                        <p class="fw-bold">Trascina i file qui o clicca per selezionarli</p>
                    `;
                }
            });
            
            // Previeni il comportamento predefinito del browser
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Aggiungi classe quando si trascina sopra
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, function() {
                    dropArea.classList.add('dragover');
                }, false);
            });
            
            // Rimuovi classe quando si esce dall'area
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, function() {
                    dropArea.classList.remove('dragover');
                }, false);
            });
            
            // Gestisci il drop
            dropArea.addEventListener('drop', function(e) {
                fileInput.files = e.dataTransfer.files;
                
                // Trigger dell'evento change per aggiornare l'interfaccia
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }, false);
        }
        
        // Filtro per tipo di file con animazioni
        const filterBadges = document.querySelectorAll('.file-type-badge');
        
        filterBadges.forEach(badge => {
            badge.addEventListener('click', function() {
                // Rimuovi la classe active da tutti i badge
                filterBadges.forEach(b => b.classList.remove('active'));
                
                // Aggiungi la classe active al badge cliccato
                this.classList.add('active');
                
                const filterType = this.getAttribute('data-filter');
                
                // Nascondi tutte le card prima
                fileCards.forEach(card => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                });
                
                // Mostra/nascondi le card in base al filtro con animazione
                setTimeout(() => {
                    fileCards.forEach((card, index) => {
                        const shouldShow = filterType === 'all' || card.getAttribute('data-type') === filterType;
                        
                        if (shouldShow) {
                            card.style.display = 'block';
                            setTimeout(() => {
                                card.style.opacity = '1';
                                card.style.transform = 'translateY(0)';
                            }, index * 50);
                        } else {
                            card.style.display = 'none';
                        }
                    });
                }, 200);
            });
        });
        
        // Inizializza i tooltip di Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Aggiungi animazioni per i modal
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('show.bs.modal', function() {
                this.querySelector('.modal-content').style.transform = 'scale(0.7)';
                this.querySelector('.modal-content').style.opacity = '0';
            });
            
            modal.addEventListener('shown.bs.modal', function() {
                this.querySelector('.modal-content').style.transition = 'all 0.3s ease-out';
                this.querySelector('.modal-content').style.transform = 'scale(1)';
                this.querySelector('.modal-content').style.opacity = '1';
            });
        });
        
        // Aggiungi animazioni per le alert
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.style.animation = 'slideInDown 0.5s ease-out';
        });
        
        // Aggiungi stile per l'animazione slideInDown
        const alertStyle = document.createElement('style');
        alertStyle.textContent = `
            @keyframes slideInDown {
                from {
                    transform: translateY(-100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(alertStyle);
    });
</script>
{% endblock %}